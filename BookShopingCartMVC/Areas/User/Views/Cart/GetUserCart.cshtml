@model ShoppingCart
@{
	ViewData["Title"] = "My Cart";
}

<div class="container py-4 min-vh-100">
	@if (TempData["success"] is not null)
	{
		<div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
			<i class="bi bi-check-circle me-2"></i>@TempData["success"]
			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
		</div>
	}
	@if (TempData["message"] is not null)
	{
		<div class="alert alert-info alert-dismissible fade show shadow-sm" role="alert">
			<i class="bi bi-info-circle me-2"></i>@TempData["message"]
			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
		</div>
	}
	@if (TempData["error"] is not null)
	{
		<div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
			<i class="bi bi-exclamation-triangle me-2"></i>@TempData["error"]
			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
		</div>
	}

	@if (Model != null && Model.CartDetails != null && Model.CartDetails.Count > 0)
	{
		<div class="card border-0 shadow-sm rounded-4 p-3 p-md-4">
			@* remove all cart *@
			<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
				<h2 class="fw-bold mb-0">
					<i class="bi bi-cart3 me-2 text-primary"></i>My Cart
				</h2>
				<form action="@Url.Action("RemoveAllItem", "Cart")" method="post" class="d-inline">
					<button type="submit" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to delete all items in your cart?')">
						<i class="bi bi-trash3 me-1"></i> Clear Cart
					</button>
				</form>
			</div>

			<!-- Cart items for medium-large screens -->
			<div class="d-none d-md-block">
				<div class="table-responsive">
					<table class="table align-middle">
						<thead class="table-light text-center">
							<tr>
								<th class="text-start">Book</th>
								<th>Cover</th>
								<th>Genre</th>
								<th>Price</th>
								<th>Qty</th>
								<th>Total</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var item in Model.CartDetails)
							{
								<tr>
									<td class="fw-medium text-start">@item.Book.BookName</td>
									<td class="text-center">
										<img src="@(string.IsNullOrEmpty(item.Book.Image) ? "/images/NoImage.png" :$"/Uploads/{item.Book.Image}")"
											 alt="@item.Book.BookName"
											 class="img-thumbnail rounded-3"
											 style="width: 60px; height: 80px; object-fit: cover;" />
									</td>
									<td class="text-center">@item.Book.Genre.GenreName</td>
									<td class="text-center">@item.Book.Price.ToString("C")</td>
									<td class="text-center">@item.Quantity</td>
									<td class="text-center fw-semibold">@((item.Book.Price * item.Quantity).ToString("C"))</td>
									<td class="text-center">
										<!-- Quantity controls -->
										<div class="d-flex align-items-center flex-column gap-1">
											<div class="quantity-control d-flex align-items-center bg-light rounded-pill p-1">
												@* minus button  *@
												<form action='@Url.Action("RemoveItem", "Cart")' method="post" class="d-inline">
													<input type="hidden" name="bookid" value="@item.BookId" />
													<button type="submit"
															class="btn btn-sm btn-light rounded-circle "
													@(item.Quantity <= 1 ? "onclick=`return confirm('Are you sure you want to delete this items in your cart?')`" : "")>
														<i class="bi bi-dash"></i>
													</button>
												</form>
												@* item quantity *@
												<span class="px-3 fw-medium">@item.Quantity</span>
												@if (item.Book?.Stock?.Quantity != null && item.Quantity < item.Book.Stock.Quantity)
												{
													@* plus button *@
													<form action='@Url.Action("AddItem", "Cart")' method="post" class="d-inline">
														<input type="hidden" name="bookid" value="@item.BookId" />
														<input type="hidden" name="redirect" value="1" />
														<button type="submit" class="btn btn-sm btn-light rounded-circle">
															<i class="bi bi-plus"></i>
														</button>
													</form>
												}
												else
												{
													// if qunatity is less than stock quantity then block for plus
													<button class="btn btn-sm btn-light rounded-circle opacity-50" disabled>
														<i class="bi bi-plus"></i>
													</button>
												}
											</div>
											@* green and red for checking if stock is available  *@
											@if (item.Book?.Stock?.Quantity != null && item.Book.Stock.Quantity > 0)
											{
												<span class="badge bg-success-subtle text-success small">
													<i class="bi bi-check-circle-fill me-1"></i>In Stock
												</span>
											}
											else
											{
												<span class="badge bg-danger-subtle text-danger small">
													<i class="bi bi-exclamation-circle-fill me-1"></i>Out of Stock
												</span>
											}
										</div>
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			</div>

			<!-- Mobile-friendly cart items display -->
			<div class="d-md-none">
				<div class="mb-3">
					<span class="badge bg-primary rounded-pill px-3 py-2 mb-2">
						<i class="bi bi-box-seam me-1"></i> @Model.CartDetails.Count item(s) in your cart
					</span>
				</div>

				@foreach (var item in Model.CartDetails)
				{
					<div class="card mb-3 border-0 rounded-4 shadow-sm">
						<div class="position-relative">


							<div class="row g-0">
								<div class="col-4 p-3 d-flex align-items-center justify-content-center">
									<div class="book-cover-container position-relative">
										<img src="~/Uploads/@(string.IsNullOrEmpty(item.Book.Image) ? "/images/NoImage.png" : $"/Uploads/{item.Book.Image}")"
											 alt="@item.Book.BookName"
											 class="img-fluid rounded-3 shadow-sm"
											 style="max-height: 130px; object-fit: cover;" />

										@if (item.Book?.Stock?.Quantity == 0)
										{
											<div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center rounded-3"
												 style="background-color: rgba(0,0,0,0.5);">
												<span class="badge bg-danger fw-bold p-2">OUT OF STOCK</span>
											</div>
										}
									</div>
								</div>
								<div class="col-8">
									<div class="card-body p-3">
										<div class="d-flex flex-column h-100">
											<div>
												<h5 class="card-title mb-1 fs-6 fw-semibold text-truncate">@item.Book.BookName</h5>
												<div class="d-flex align-items-center mb-2">
													<span class="badge bg-light text-secondary me-2">
														<i class="bi bi-bookmark-fill me-1 small"></i>@item.Book.Genre.GenreName
													</span>
												</div>
											</div>

											<div>
												<div class="d-flex justify-content-between align-items-center mb-2">
													<span class="fw-bold fs-5">@item.Book.Price.ToString("C")</span>
													<span class="text-success fw-bold">
														@((item.Book.Price * item.Quantity).ToString("C"))
													</span>
												</div>

												<!-- Quantity controls -->
												<div class="d-flex align-items-center justify-content-between">
													<div class="quantity-control d-flex align-items-center bg-light rounded-pill p-1">

														<form action='@Url.Action("RemoveItem", "Cart")' method="POST">
															<button class="btn btn-sm btn-light rounded-circle @(item.Quantity <= 1 ? "opacity-50" : "")"
																	onclick="removeItem(@item.BookId)"
															@(item.Quantity <= 1 ? "onclick=`return confirm('Are you sure you want to delete this items in your cart?')`" : "")>
																<i class="bi bi-dash"></i>
															</button>
														</form>
														<span class="px-3 fw-medium">@item.Quantity</span>
														@if (item.Book?.Stock?.Quantity != null && item.Quantity < item.Book.Stock.Quantity)
														{
															<form action='@Url.Action("AddItem", "Cart")' method="POST">
																<button class="btn btn-sm btn-light rounded-circle"
																		onclick="addItem(@item.BookId)">
																	<i class="bi bi-plus"></i>
																</button>
															</form>
														}
														else
														{
															<button class="btn btn-sm btn-light rounded-circle opacity-50" disabled>
																<i class="bi bi-plus"></i>
															</button>
														}
													</div>

													@if (item.Book?.Stock?.Quantity != null && item.Book.Stock.Quantity > 0)
													{
														<span class="badge bg-success-subtle text-success small">
															<i class="bi bi-check-circle-fill me-1"></i>In Stock
														</span>
													}
													else
													{
														<span class="badge bg-danger-subtle text-danger small">
															<i class="bi bi-exclamation-circle-fill me-1"></i>Out of Stock
														</span>
													}
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				}
			</div>

			<!-- Order summary section -->
			<div class="card mt-4 border-0 bg-light rounded-4 p-3">
				<div class="row">
					<div class="col-md-6 mb-3 mb-md-0">
						<div class="d-flex flex-column h-100 justify-content-center">
							<h4 class="fw-bold mb-2">Order Summary</h4>
							<div class="d-flex justify-content-between">
								<span class="fw-bold">Total:</span>
								<span class="fw-bold text-success fs-5">
									@Model.CartDetails.Select(item => item.Book.Price * item.Quantity).Sum().ToString("C")
								</span>
							</div>
						</div>
					</div>
					<div class="col-md-6">
						<div class="d-grid">
							<a class="btn btn-primary btn-lg py-3 rounded-3 shadow-sm" href="@Url.Action("Checkout", "Cart")">
								<i class="bi bi-credit-card me-2"></i> Proceed to Checkout
							</a>
							<a class="btn btn-outline-primary text-decoration-none mt-2" href='@Url.Action("Books", "Home")'>
								<i class="bi bi-arrow-left me-1"></i> Continue Shopping
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	}
	else
	{
		<div class="card border-0 shadow-sm rounded-4 p-4">
			<div class="text-center py-5">
				<div class="mb-4">
					<i class="bi bi-cart-x display-1 text-secondary opacity-50"></i>
				</div>
				<h2 class="fw-bold mb-2">Your cart is empty</h2>
				<p class="text-muted mb-4">Looks like you haven't added any books to your cart yet.</p>
				<a href="@Url.Action("Books","Home")" class="btn btn-primary btn-lg px-4 py-2 shadow-sm">
					<i class="bi bi-book me-2"></i> Browse Books
				</a>
			</div>
		</div>
	}
</div>