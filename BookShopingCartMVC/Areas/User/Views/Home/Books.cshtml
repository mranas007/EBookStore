@model BookDisplayViewModel
@{
	ViewData["Title"] = "Browse Our Collection";
}

<div class="container py-4">
	<!-- Search and Filter Section -->
	<div class="card shadow-sm border-0 rounded-4 mb-5">
		<div class="card-body p-4">
			<h2 class="h4 fw-semibold mb-4">Find Your Next Read</h2>
			<form asp-controller="Home" asp-action="Books" class="row g-3">
				<div class="col-md-4">
					<div class="input-group">
						<span class="input-group-text bg-light">
							<i class="bi bi-search text-muted"></i>
						</span>
						<input type="text" class="form-control py-2" value="@Model.STerm" id="sterm" name="sterm" placeholder="Search by Book Title">
					</div>
				</div>

				<div class="col-md-4">
					<select class="form-select py-2" id="genreId" name="genreId">
						<option value="">All Genres</option>
						@foreach (var genre in Model.Genres)
						{
							<option selected="@(genre.Id == Model.GenreId)" value="@genre.Id">@genre.GenreName</option>
						}
					</select>
				</div>

				<div class="col-md-4 d-flex align-items-center gap-2">
					<button type="submit" class="btn btn-primary px-4 py-2 flex-grow-1">
						<i class="bi bi-funnel me-2"></i>Filter
					</button>
					<a href="@Url.Action("Books", "Home")" class="btn btn-outline-secondary px-4 py-2">
						<i class="bi bi-arrow-counterclockwise"></i>
					</a>
				</div>
			</form>
		</div>
	</div>

	<!-- Book List -->
	@if (Model.Books.Any())
	{
		<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4">
			@foreach (var item in Model.Books)
			{
				int maxLength = 120;
				<div class="col">
					<div class="card h-100 border-0 shadow-sm rounded-4 overflow-hidden position-relative hover-scale transition">
						<!-- Book Image + Genre -->
						<div class="position-relative">
							<img src="~/Uploads/@item.Image" class="card-img-top object-fit-cover" alt="@item.BookName cover"
								 style="height: 220px; width: 100%; object-fit: cover;">
							<span class="badge bg-gradient bg-primary text-white position-absolute top-0 start-0 m-2 px-3 py-1 rounded-pill small shadow">
								@item.GenreName
							</span>
						</div>

						<!-- Book Info -->
						<div class="card-body d-flex flex-column">
							<h5 class="card-title fw-semibold text-primary mb-1">@item.BookName</h5>
							<p class="text-muted small mb-2">by <span class="fw-medium">@item.AuthorName</span></p>

							<p class="card-text text-secondary small mb-3">
								@(item.Description?.Length > maxLength ? item.Description.Substring(0, maxLength) + "..." : item.Description)
							</p>

							<!-- Price + Actions -->
							<div class="mt-auto">
								<div class="d-flex justify-content-between align-items-center mb-3">
									<span class="fw-bold text-success fs-6 mb-0">@item.Price.ToString("C")</span>

									<i onclick="likeToggle(@item.Id)"
									   class="bi @(item.IsLike == true ? "bi-heart-fill" : "bi-heart") text-danger"
									   style="cursor: pointer;"
									   title="@(item.IsLike == true ? "Remove from favorites" : "Add to favorites")"></i>

								</div>

								<div class="d-flex gap-2">
									<button onclick="add(@item.Id)" style="font-size:13px;" class="btn btn-sm btn-success d-flex align-items-center justify-content-center flex-grow-1 px-3 py-2 rounded-3">
										<i class="bi bi-cart-plus me-1"></i>
										Add to Cart
									</button>
									<a asp-controller="Home" asp-action="BookDetails" asp-route-id="@item.Id"
									   class="btn btn-sm btn-outline-primary d-flex align-items-center justify-content-center flex-grow-1 px-3 py-2 rounded-3">
										<i class="bi bi-book me-1"></i>
										Details
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			}
		</div>
	}
	else
	{
		<div class="text-center py-5">
			<div class="display-5 text-muted mb-3">
				<i class="bi bi-book"></i>
			</div>
			<h3 class="h4">No books found</h3>
			<p class="text-muted">Try adjusting your search or filter criteria</p>
			<a href="@Url.Action("Index", "Home")" class="btn btn-primary mt-3">Reset Filters</a>
		</div>
	}
</div>

@section Scripts {
	<script>

		function likeToggle(e) {
			$.ajax({
				url: `@Url.Action("AddOrDelete", "UserLike")/${e}`, // Adjust the URL to match your controller and action
				method: 'POST',
				success: function (data) {
					window.location.reload(true);
				},
				error: function () {
					console.error('Failed to fetch cart item count.');
				}
			});
		}

		function add(id) {
			$.ajax({
				type: "POST",
				url: '@Url.Action("AddItem", "Cart")',
				data: { bookId: id },
				success: function (response) {
					if (response.success) {
						console.log(response.message);
						$('.cartItemCount').text(response.data);
					} else {
						console.log(response.message);
					}
				},
				error: function () {
					console.log("An error occurred while adding the book to the cart.");
				}
			});
		}
	</script>
}